generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ======================== USUÁRIOS ========================

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phone     String?  @unique
  password  String
  avatar    String?
  pixKey    String?
  phoneVerifiedAt DateTime?
  lastSeenAt DateTime @default(now())
  lastInactivityReminderAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  home      Home?    @relation("ActiveHome", fields: [homeId], references: [id])
  homeId    String?
  isAdmin   Boolean  @default(false)
  homeMemberships HomeMember[]

  // Relacionamentos Financeiros
  expensesPaid    Expense[]      @relation("PaidBy")
  expenseShares   ExpenseShare[]
  
  // Relacionamentos de Compras
  itemsAdded      ShoppingItem[] @relation("AddedBy")
  itemsPurchased  ShoppingItem[] @relation("PurchasedBy")
  itemNotes       ItemNote[]

  // Relacionamentos de Tarefas (NOVO)
  tasks           Task[]
  passwordResetTokens PasswordResetToken[]
  refreshSessions RefreshSession[]
  auditLogs       AuditLog[]
  notifications   Notification[]

  @@index([homeId])
  @@index([lastSeenAt])
  @@index([lastInactivityReminderAt])
  @@map("users")
}

// ======================== SESSOES DE REFRESH TOKEN ========================

model RefreshSession {
  id                String   @id
  tokenHash         String   @unique
  expiresAt         DateTime
  revokedAt         DateTime?
  replacedBySessionId String?
  lastUsedAt        DateTime?
  ipAddress         String?
  userAgent         String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String

  @@index([userId, revokedAt])
  @@index([expiresAt])
  @@map("refresh_sessions")
}

// ======================== CASA ========================

model Home {
  id         String   @id @default(cuid())
  name       String
  inviteCode String   @unique @default(cuid())
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  members       HomeMember[]
  activeUsers   User[]       @relation("ActiveHome")
  categories    Category[]
  expenses      Expense[]
  shoppingLists ShoppingList[]
  tasks         Task[]
  auditLogs     AuditLog[]
  notifications Notification[]

  @@map("homes")
}

model HomeMember {
  id        String   @id @default(cuid())
  role      HomeRole @default(MEMBER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  home      Home     @relation(fields: [homeId], references: [id], onDelete: Cascade)
  homeId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String

  @@unique([homeId, userId])
  @@index([userId])
  @@index([homeId])
  @@map("home_members")
}

enum HomeRole {
  ADMIN
  MEMBER
}

// ======================== CATEGORIAS ========================

model Category {
  id          String       @id @default(cuid())
  name        String
  icon        String
  color       String
  type        CategoryType @default(VARIABLE)
  isRecurring Boolean      @default(false)
  recurringDay Int?

  home      Home      @relation(fields: [homeId], references: [id], onDelete: Cascade)
  homeId    String
  expenses  Expense[]

  @@index([homeId])
  @@map("categories")
}

enum CategoryType {
  FIXED
  VARIABLE
  ONETIME
}

// ======================== DESPESAS ========================

model Expense {
  id          String    @id @default(cuid())
  description String
  amount      Float
  date        DateTime  @default(now())
  dueDate     DateTime?
  receipt     String?
  notes       String?
  splitType   SplitType @default(EQUAL)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  paidBy      User      @relation("PaidBy", fields: [paidById], references: [id])
  paidById    String
  category    Category  @relation(fields: [categoryId], references: [id])
  categoryId  String
  home        Home      @relation(fields: [homeId], references: [id], onDelete: Cascade)
  homeId      String
  shares      ExpenseShare[]

  @@index([homeId, date])
  @@index([paidById])
  @@index([categoryId])
  @@map("expenses")
}

enum SplitType {
  EQUAL
  CUSTOM
  INDIVIDUAL
}

// ======================== DIVISÃO DAS DESPESAS ========================

model ExpenseShare {
  id        String    @id @default(cuid())
  amount    Float
  splitPercent Float?
  isPaid    Boolean   @default(false)
  paidAt    DateTime?
  proofUrl  String?
  proofDescription String?

  expense   Expense   @relation(fields: [expenseId], references: [id], onDelete: Cascade)
  expenseId String
  user      User      @relation(fields: [userId], references: [id])
  userId    String

  @@unique([expenseId, userId])
  @@index([userId, isPaid])
  @@index([expenseId, isPaid])
  @@map("expense_shares")
}

// ======================== LISTA DE COMPRAS ========================

model ShoppingList {
  id        String           @id @default(cuid())
  name      String
  type      ShoppingListType @default(SIMPLE)
  isActive  Boolean          @default(true)
  
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  home      Home             @relation(fields: [homeId], references: [id], onDelete: Cascade)
  homeId    String
  items     ShoppingItem[]

  @@index([homeId])
  @@map("shopping_lists")
}

enum ShoppingListType {
  SIMPLE
  WISHLIST
}

// ======================== ITENS DA LISTA ========================

model ShoppingItem {
  id              String      @id @default(cuid())
  name            String
  description     String?
  quantity        Int         @default(1)
  isPurchased     Boolean     @default(false)
  purchasedAt     DateTime?
  
  targetPriceMin  Float?
  targetPriceMax  Float?
  currentPrice    Float?
  lowestPrice     Float?
  lowestPriceUrl  String?
  lowestPriceDate DateTime?
  
  status       ItemStatus @default(PENDING)
  priority     Priority   @default(MEDIUM)
  alertOnPrice Boolean    @default(true)
  alertSent    Boolean    @default(false)
  
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  list         ShoppingList @relation(fields: [listId], references: [id], onDelete: Cascade)
  listId       String
  addedBy      User         @relation("AddedBy", fields: [addedById], references: [id])
  addedById    String
  purchasedBy  User?        @relation("PurchasedBy", fields: [purchasedById], references: [id])
  purchasedById String?
  urls         ProductUrl[]
  priceHistory PriceHistory[]
  notes        ItemNote[]

  @@index([listId, createdAt])
  @@index([addedById])
  @@index([purchasedById])
  @@map("shopping_items")
}

enum ItemStatus {
  PENDING
  WATCHING
  IN_RANGE
  PURCHASED
  CANCELLED
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ======================== URLs DOS PRODUTOS ========================

model ProductUrl {
  id        String    @id @default(cuid())
  url       String
  store     String
  lastPrice Float?
  lastCheck DateTime?
  isActive  Boolean   @default(true)

  item      ShoppingItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId    String

  @@map("product_urls")
}

// ======================== HISTÓRICO DE PREÇOS ========================

model PriceHistory {
  id         String   @id @default(cuid())
  price      Float
  url        String
  store      String
  capturedAt DateTime @default(now())

  item       ShoppingItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId     String

  @@map("price_history")
}

// ======================== NOTAS DOS ITENS ========================

model ItemNote {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())

  item      ShoppingItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId    String
  author    User         @relation(fields: [authorId], references: [id])
  authorId  String

  @@map("item_notes")
}

// ======================== TAREFAS (GAMIFICATION) ========================

model Task {
  id          String   @id @default(cuid())
  title       String
  description String?
  points      Int      @default(10)
  isDone      Boolean  @default(false)
  frequency   String?  // Ex: "DAILY", "WEEKLY"
  
  dueDate     DateTime?
  completedAt DateTime?

  // Relacionamentos
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])
  assignedToId String?
  
  home         Home    @relation(fields: [homeId], references: [id], onDelete: Cascade)
  homeId       String

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([homeId, isDone, createdAt])
  @@index([assignedToId])
  @@map("tasks")
}

// ======================== RECUPERACAO DE SENHA ========================

model PasswordResetToken {
  id         String   @id @default(cuid())
  tokenHash  String   @unique
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime @default(now())

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String

  @@index([userId, expiresAt])
  @@index([usedAt])
  @@map("password_reset_tokens")
}

// ======================== AUDITORIA ========================

model AuditLog {
  id         String   @id @default(cuid())
  action     String
  metadata   Json?
  createdAt  DateTime @default(now())

  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  userId     String?

  home       Home?    @relation(fields: [homeId], references: [id], onDelete: SetNull)
  homeId     String?

  @@index([userId, createdAt])
  @@index([homeId, createdAt])
  @@index([action, createdAt])
  @@map("audit_logs")
}

// ======================== NOTIFICACOES ========================

model Notification {
  id         String   @id @default(cuid())
  type       String
  title      String
  message    String
  metadata   Json?
  isRead     Boolean  @default(false)
  readAt     DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     String

  home       Home?    @relation(fields: [homeId], references: [id], onDelete: SetNull)
  homeId     String?

  @@index([userId, isRead, createdAt])
  @@index([homeId, createdAt])
  @@index([type, createdAt])
  @@map("notifications")
}
